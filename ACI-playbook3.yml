---

- name: PLAY 3
  hosts: apic
  connection: local
  gather_facts: no
  
  tasks:
    - name: TASK 1 - List of APP profiles for tenants
      aci_ap:
        hostname: "{{ inventory_hostname }}"
        username: "{{ aci_username }}"
        password: "{{ aci_password }}"
        validate_certs: no
        state: query
      register: prod_ap

    - name: TASK 2 - Create list of just APP names
      set_fact:
        apps: "{{ prod_ap | json_query('current[*].fvAp.attributes.name') }}"

    - name: TASK 3a - List of AP profiles for tenants
      aci_epg:
        hostname: "{{ inventory_hostname }}"
        username: "{{ aci_username }}"
        password: "{{ aci_password }}"
        validate_certs: no
        tenant: datacenter
        state: query
      register: prod_apps        
      
    # - name: TASK 3 - List of AP profiles for tenants
      # aci_epg:
        # hostname: "{{ inventory_hostname }}"
        # username: "{{ aci_username }}"
        # password: "{{ aci_password }}"
        # validate_certs: no
        # ap: "{{ item }}"
        # tenant: datacenter
        # state: query
      # with_items: "{{ apps }}"
      # register: prod_apps
      
    
    - name: TASK 2 - Create list of just APP names
      set_fact:
        #apps: "{{ prod_apps | json_query('current[0].fvTenant.children[*].fvAp.attributes.name') }}"
        apps: "{{ prod_apps | json_query('current[0].fvAp.attributes.name') }}"
        #epgs: "{{ prod_apps | json_query('current[0].fvTenant.children[*].fvAp.children[*].fvAEPg.attributes.name') }}"
        #epgs: "{{ prod_apps | json_query('current[0].fvAp.children[*].fvAEPg.attributes.name') }}"
        epgs: "{{prod_apps | json_query('result.current[0].fvAp.children[*].fvAEPg.attributes.name') }}"
        
    - name: TASK 2 debug
      debug: var=epgs
    
    - name: test 2 test
      debug: var=prod_apps
      
      
      
      
    # - name: TASK 3 - Create list of just APP names
      # set_fact:
        # #ap_epg: "{{ ap_epg|default([]) + [ {'name': item.fvTenant.children.fvAp.attributes.name'), 'gender': item.fvTenant.children.fvAp.children.fvAEPg.attributes.name} ] }}"
        # ap_epg: "{{ ap_epg | default([]) + [ { 'item': item } ] }}"
      # with_items: "{{ prod_apps.current | map(attribute='name') | list  }}"

    # - name: Print list of apps in tenant
      # debug: var=ap_epg
    
   # - name: test1
    #    test : "{{ test | default([]) + [ { 'item': item } ] }}"
    #  with_items: 
    #    - "{{ prod_apps.current | map(attribute='current') | map('from_json') | map(attribute='fvAp') | sum(start=[]) | map(attribute='fvAEPg') | list }}"
    #  
    #- name tesr
    #  debug: var=test
      
